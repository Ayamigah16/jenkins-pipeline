# Runbook

## Purpose
Operational runbook for infrastructure provisioning (Terraform), host configuration (Ansible), and CI/CD execution (Jenkins).

## Prerequisites
- AWS account with permissions for EC2, IAM, VPC, ECR, S3, and DynamoDB
- Terraform >= 1.6
- Ansible >= 2.15

## Provision Infrastructure
1. Bootstrap state backend:
```bash
cd infra/terraform/bootstrap
terraform init
terraform apply -var='state_bucket_name=<globally-unique-bucket>' -var='lock_table_name=jenkins-pipeline-tf-locks'
```
2. Provision AWS resources:
```bash
cd ../aws
cp terraform.tfvars.example terraform.tfvars
cp backend.hcl.example backend.hcl
terraform init -backend-config=backend.hcl
terraform apply
```

## Configure Hosts
```bash
cd ../../ansible
# optional: cp group_vars/all/vault.yml.example group_vars/all/vault.yml && ansible-vault encrypt group_vars/all/vault.yml
# optional fallback (instead of vault): export JENKINS_ADMIN_PASSWORD='<strong-password>'
./run-playbook.sh
```
`run-playbook.sh` loads `infra/ansible/.env` generated by Terraform.

## Jenkins Configuration
- Create Jenkins credentials:
  - `git_credentials` (GitHub token/user)
  - `ec2_ssh` (deploy SSH key from `infra/keys/<key_pair_name>.pem`)
  - `registry_creds` only if not using ECR IAM auth
- Configure pipeline from repository `Jenkinsfile`
- Set `REGISTRY`, `EC2_HOST`, and related values from Terraform outputs

## Standard Deployment Flow
1. Commit and merge to `main` or `develop`
2. Jenkins runs: checkout -> build -> test -> security gates -> image build/scan -> push -> deploy -> verify -> cleanup
3. Deploy host serves app on port `80`

## Manual Verification
```bash
curl -fsS http://<DEPLOY_PUBLIC_DNS>/health
ssh ec2-user@<DEPLOY_PUBLIC_DNS> 'docker ps'
ssh ec2-user@<DEPLOY_PUBLIC_DNS> 'docker logs secure-flask-app --tail=200'
```

## Rollback
1. Automatic rollback is executed on failed post-cutover health checks.
2. Manual rollback if required:
```bash
ssh ec2-user@<DEPLOY_PUBLIC_DNS> "docker ps --format '{{.Names}} {{.Image}}'"
ssh ec2-user@<DEPLOY_PUBLIC_DNS> 'docker rm -f secure-flask-app'
ssh ec2-user@<DEPLOY_PUBLIC_DNS> 'docker run -d --name secure-flask-app -p 80:3000 <previous-image-tag>'
```

## Troubleshooting
- `terraform init backend error`: confirm S3 bucket/table names and IAM permissions
- `ansible unreachable`: verify SG rules, public IPs, and SSH key
- `ECR login failed`: validate instance role permissions and region
- `Trivy not found`: re-run Ansible Jenkins role or install manually
- `deployment health timeout`: inspect container logs on deploy host

## Incident Response
- Rotate compromised secrets (Jenkins creds, SSH keys, tokens)
- Revoke IAM sessions and audit CloudTrail
- Rebuild and redeploy from a clean commit after security scans pass
